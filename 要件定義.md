## 1. eBay連携・API関連

0. **ebay公式ドキュメント**
  - https://developer.ebay.com/api-docs/sell/finances/resources/transaction/methods/getTransactions （Finances API/ getTransactions）
  - https://developer.ebay.com/api-docs/sell/fulfillment/resources/order/methods/getOrders （Fulfillment API/ getOrders）

1. **アクセス対象となる店舗(出品者アカウント)の数**
   - 単一アカウントか、複数アカウント(マルチテナント対応)か。
   - 複数対応の場合、アクセストークンやリフレッシュトークンはアカウントごとに保持する必要がある。

2. **取得対象のオーダーステータスや期間**
   - `getOrders` に対して、どの期間の注文を取得したいのか(当日分のみ、過去30日分など)。
   - Fulfillment APIではクエリパラメータによって検索範囲を指定可能か(公式ドキュメントを要確認)。
   - キャンセルされた注文や返金などの扱いはどうするか。

3. **データ保存の範囲・方法**
   - 取得したOrdersのうち、どの情報をDBで保持するか。
     - 全てのJSONを`jsonb`などに一括保管 + 必要な項目だけ別カラム化
     - カラムとして細かく分割保持
   - eBay側で変更・更新があった注文(例: 履歴、部分返金、ステータス変化)をどのように同期するか。

4. **APIコールのリトライや例外時の挙動**
   - eBay APIの一時的な障害やネットワーク不良で呼び出しが失敗した場合のリトライポリシー。
   - 1時間ごとのバッチで失敗したときは次回に再実行？ それともすぐ再試行？
   - レスポンスが4xxの場合(認証エラーなど)、自動でリフレッシュトークンを再度取り直して再リクエストするのか。

5. **APIのレートリミット**
   - eBay側のAPIレートリミット(1秒あたり/分あたり/日あたり)を把握しているか。
   - 定期実行によってリミットを超える可能性がある場合の制御方法はどうするか。

---

## 2. トークン管理・認証まわり

1. **Ebay::AuthClient でのトークン取得フロー**
   - OAuthコードフローなのか、リフレッシュトークンをすでに取得済みで定期的にアクセストークンを更新する方法か。
   - 有効期限切れのタイミングで再認証が必要になるケースの扱い。
   - そもそもトークンの有効期限は何分/何時間か、公式ドキュメントでどう指定されているか。

2. **リフレッシュトークンの保管**
   - `config/credentials.yml.enc`に保持するか、DBに保存するか。
   - 毎回Rails起動時にcredentialsから読み込む方式か、最終更新時刻を保持し自動更新するロジックをどう組むか。

3. **本番環境/検証環境へのデプロイ時のトークン設定**
   - すべての環境で使うクレデンシャルの管理方法(マスタ or 環境ごとに分割するか)。
   - Docker Secretsやサードパーティの秘密情報管理サービス(AWS Secrets Manager等)との連携有無。

---

## 3. 1時間ごとの定期実行の設計

1. **ジョブスケジューラの選定**
   - Rails標準の`ActiveJob` + cron(wheneverやsidekiq-cronなど)を使うか、`sidekiq` + sidekiq-schedulerなどを使うか。
   - Docker環境でのcron実行(コンテナ内でcronを動かすか、別コンテナ(ワーカーコンテナ)でスケジューリングするか)の方針。

2. **非同期ジョブの実行時間と重複**
   - 定期的に実行されるジョブが前回の実行と重なった場合にどうするか(ロックが必要か)。
   - APIへのアクセス時間を短縮するため、実行タイミングを分散する必要はあるか。

3. **取得件数が大量の場合**
   - 1時間単位で膨大な注文が発生する場合、パフォーマンスや通信量、API呼び出し上限をどう管理するか。
   - ページネーション(オフセット)の指定や、前回取得以降の更新分のみを取得するなどの仕組みをどう設計するか。

---

## 4. データモデル・DBスキーマ

1. **EbayOrderモデルの項目**
   - `order_id`, `order_data(jsonb)`, `buyer_name`, `status`, `created_at`などの最低限の項目以外に、必要な項目は何か。
   - eBay上で存在する「LineItem」や「ShippingAddress」などを別モデルで正規化管理したいか。
   - 合計金額や通貨、手数料など、帳票処理で必要な数値項目は？

2. **更新・再取得**
   - `order_id`でユニーク制約をかけるだけで十分か。
   - DBに存在する注文が再度APIから取得された場合、既存データを上書きして更新するか、更新履歴テーブルを持つか。
   - 「削除・キャンセル」が発生した場合の取り扱い。

3. **拡張性**
   - 例えば将来的に「商品の出荷状況」や「伝票番号」などを管理したい場合、どう拡張するか。
   - 複数アカウント(マルチテナント)に対応するなら`ebay_account_id`カラムなどが必要になるか。

---

## 5. コントローラ、UI/UX

1. **ブラウザ上での表示・操作**
   - 単に一覧表示のみか、詳細画面(受注の明細)や検索・フィルタリングを設けるか。
   - 表示するカラム(受注ID、購入者、ステータス、金額、購入日時など)
   - ページネーションやソート機能。
   - スマホ対応・レスポンシブ対応の要否(タブレットやスマホから注文一覧を見たいか？)

2. **更新タイミング**
   - 1時間毎のバッチ更新が完了した後、UIはユーザ操作なしでもリアルタイムに更新表示をしたいか(Hotwire/Turbo Streamsでプッシュ？ あるいはリロード前提？)。
   - 「今すぐ最新情報を取得」ボタンの手動更新を付けるか。

3. **セキュリティ(認可)**
   - 内部管理用システムであれば、Deviseなどで管理者アカウントがログインしないと見られないようにする。
   - 権限(管理者/一般スタッフなど)による表示制御が必要か。

---

## 6. テスト戦略・品質保証

1. **RSpecテストレベルの決定**
   - Modelテスト、Serviceテスト、Request/Controllerテストの範囲以外に、Systemテスト(ブラウザ操作シミュレーション)を行うか。
   - 大量データやAPI障害時の負荷テストを実施するか。

2. **CI/CDパイプライン**
   - GitHub ActionsやCircleCIなどを使い、Push/PR時に自動テストを回すか。
   - DockerベースのCI/CDでどこまで検証するか。

3. **本番リリース前の確認事項**
   - ステージング環境を用意して、API連携が正しく動くか試験を行うか(デモ用トークン等の扱い)。
   - 本番稼働中にエラーが起きた場合のログ監視・通知体制(ログはどこに集約するか、Slack通知など)。

---

## 7. ロギング・監視

1. **エラー・例外の通知**
   - 例外発生時、Slackやメールに通知が欲しい場合の設定。
   - Sentryなどのエラー監視サービスを導入するか。

2. **バッチ成功/失敗ログ**
   - バッチの実行開始/終了や取得件数、失敗件数を残しておきたいか。
   - 失敗時のリトライ数や発生時刻の記録方法。

3. **API呼び出しのトレース**
   - eBay APIの各呼び出しをトレースIDなどで紐付けたいか。
   - レスポンス内容や発行したクエリ回数などをモニタリングする仕組みが必要か。

---

## 8. Docker/デプロイ構成

1. **ローカル開発環境**
   - `docker-compose up` でRails, PostgreSQL, Node, Redis(必要なら)を一式起動させる想定か。
   - ホットリロードやデバッグをどう行うか(通常Rails + `bin/dev`利用 + ホストマシンとのVolumeマウント)。

2. **本番用Dockerfile**
   - マルチステージビルドにするか、Railsアプリのイメージをビルド → スリム化するか。
   - Rails CredentialsやeBay APIトークンなど機密情報の注入をどのタイミング/方法で行うか。
   - DBやRedisなどはマネージドサービスを利用するのか、同じDocker内に含めるのか。

3. **オートスケーリング**
   - 大量注文が来た時のスケーリング(コンテナの増減)を想定しているか。
   - API呼び出しの頻度が増大しないよう調整が必要か(スケーリングが増えるとレートリミットを超えやすくなるケースもあり)。

---

## 9. 将来的な拡張要件

1. **出荷指示などFulfillmentを深く使う可能性**
   - 今後、オーダー情報の取得だけでなく、出荷処理やトラッキング番号更新、部分返金などもやる予定があるか。
   - その場合、Fulfillment APIやOrder API以外のeBay APIとも連携する設計が必要。

2. **他のECプラットフォームとの統合**
   - AmazonやShopifyなど、他プラットフォームの注文とも一元管理したい構想があるか。
   - 将来的には「アカウント種別」「プラットフォームID」などを持つDBスキーマにしておくか検討。

3. **運用側のUI(管理画面)**
   - Rails AdminやActiveAdminなどでまとめて管理するか、カスタムで管理画面を作るか。
   - Excel/CSVでのレポート出力、売上集計などのニーズはあるか。

